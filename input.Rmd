---
output: 
  html_document:
  toc: true
  theme: united
params: 
    set_title: "My Title!"
title: "`r params$set_title`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(rms)
library(Hmisc)
library(pec)
library(prodlim)
library(reshape2)

# load the commonly used functions
source('C:/Users/tomli/Desktop/DM/DM R functions.r')
```

**Bootstrap = 3**

#### (1) Full Model 
```{r fullmodel development, include = FALSE}
# Model development 
# imputing missing data
completed <- d
imputed <- impute.transcan(imp, imputation=1, data=d, list.out=TRUE, pr=FALSE, check=FALSE) 
completed[names(imputed)] <- imputed
dd <<- datadist(completed); options(datadist ="dd")

fullmodel <- fit.mult.impute(fm, fitter = cph, xtrans = imp, data = d, x=TRUE, y=TRUE, surv=TRUE, time.inc=5)
```

```{r fullmodel plots}
# estimation curve for variable
ggplot(Predict(fullmodel), sepdiscrete ='vertical', nlevels=4, vnames ='names')
# estimation result
fullmodel
# figure 1 - importance of each variable
# anova(fullmodel)
plot(anova(fullmodel, tol=1e-13))
```

**Model Validation**
```{r validation, warning = FALSE}
c.stat <- Cindex_full(model = fullmodel, bootstrap = 4) # Should be 100
```

**Model Calibration**
  
```{r calibration, warning = FALSE}
Calibrate_full(model = fullmodel, bootstrap = 4) # Should be 100

```

```{r calibration_sex, warning = FALSE, eval = FALSE}
# # predict survival probability and observed probability for male group
# completed$pred <- 1 - predictSurvProb(fullmodel, completed, times=5)
# dat <- FUN.deciles_mean_pred(completed[completed$female == FALSE,])
# dat.melt <- melt(dat, id.vars = 'Deciles', variable.name = 'Group', value.name = 'Risk')
# p1 <- plot_cal_bar(dat.melt)+
#             ggtitle("Male")
# 
# # predict survival probability and observed probability for female group
# dat <- FUN.deciles_mean_pred(completed[completed$female == TRUE,])
# dat.melt <- melt(dat, id.vars = 'Deciles', variable.name = 'Group', value.name = 'Risk')
# p2 <- plot_cal_bar(dat.melt, colours = c('pink', 'darkred'))+
#             ggtitle("Female")
# 
# multiplot(p1, p2, cols = 1)
```

#### (2) Age interaction 
**Age interaction**
``` {r age interaction, eval = TRUE}
z <- predict(fullmodel, type="terms")
z.age <- z[, "age"]
z.other <- subset(z, select=-age)
f.ia <- cph(fullmodel$y ~ z.age * z.other)
anova(f.ia )
```

```{r, ref.label='validation', warning = FALSE, eval = FALSE}
```

```{r, ref.label='calibration', warning = FALSE, eval = FALSE}
```

#### (3) Simplified model 
**Model approximation** 
  Set at 90% of R^2^

```{r modelapprox, warning = FALSE, message = FALSE}
approx <- FUN.approx(fullmodel, completed, fm = fm)
plot(approx$r2, approx$frac, type = "b", ylab = "Fraction", xlab = expression(approx$r2))
tab <- cbind(number = (length(approx$r2)):1, 
             r2 = c(approx$r2), 
             predictor = approx$predictor)
tab
# write.csv(tab, "table_r2.csv")

# Validation for the approximate model
boots_results <- valid_approx(5, fm = fm, completedata = completed) # Should be 100

      # Discrimination
c_index <- boots_results$validation
c_index_CI <- quantile(c_index, c(0.025, 0.975))

      # Calibration
p1 <- plot_cal_bar(boots_results$calibration)
p1
```

Mean c-index = `r round(mean(c_index), 4)`

Approx model formula is: 
```{r}
approx$approx_model$sformula

# save approx model
# model <- fit.mult.impute(fm_approx, fitter = cph, xtrans = imp, data = d, x=TRUE, y=TRUE, surv=TRUE, time.inc=5)
```

```{r, ref.label='calibration', warning = FALSE}
```


**External validation**
```{r modelapprox, warning = FALSE, message = FALSE}

source('C:/Users/tomli/Desktop/DM/External validation.r')

path <- "C:\\Users\\tomli\\Desktop\\Tom folder\\Chao\\Chao - 29Sep2016\\External validation\\CU"
wd_mortality <- paste0(path, "\\mortality_full_8.Rdata") # Mortality data
wd_stroke <- paste0(path, "\\stroke_20170214.Rdata") # Stroke data
wd_chd <- paste0(path, "\\chd_20170220.Rdata") # CHD data

# outcome: 'chd', 'mortality', 'stroke'
# CU_UKPDS: 'CU', 'UKPDS'
# sex: 'Female', 'Male', 'All' 
external_validation(outcome = 'mortality', CU_UKPDS = 'CU', sex = 'Male')$figure
external_validation(outcome = 'stroke', CU_UKPDS = 'CU', sex = 'Male')$figure
external_validation(outcome = 'chd', CU_UKPDS = 'CU', sex = 'Male')$figure
external_validation(outcome = 'stroke', CU_UKPDS = 'UKPDS', sex = 'Male')$figure
external_validation(outcome = 'chd', CU_UKPDS = 'UKPDS', sex = 'Male')$figure

# Table of c index
c_index_all <- expand.grid(outcome = c('mortality','stroke','chd'), 
                           CU_UKPDS = c('CU','UKPDS'), 
                           sex = c('Male','Female','All')) %>%
      
                  filter(! (outcome == 'mortality' & CU_UKPDS == 'UKPDS')) %>%
      
                  mutate(c_index = apply(., 1, function(x)
                        external_validation(x[1],x[2],x[3])$c_index))


c_index_all %>%
      ggplot(aes(x = outcome, y = c_index, fill = CU_UKPDS)) +
            geom_bar(stat= 'identity', position = 'dodge', width = 0.5) +
            facet_grid(. ~ sex)


```


