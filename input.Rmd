---
output: 
  html_document:
  toc: true
  theme: united
params: 
    set_title: "My Title!"
title: "`r params$set_title`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(rms)
library(Hmisc)
library(pec)
library(prodlim)
library(reshape2)

# load the commonly used functions
source('C:/Users/tomli/Desktop/DM/DM R functions.r')
```

**Bootstrap = 3**

#### (1) Full Model 
```{r fullmodel development, include = FALSE}
# Model development 
# imputing missing data
completed <- d
imputed <- impute.transcan(imp, imputation=1, data=d, list.out=TRUE, pr=FALSE, check=FALSE) 
completed[names(imputed)] <- imputed
dd <<- datadist(completed); options(datadist ="dd")

fullmodel <- fit.mult.impute(fm, fitter = cph, xtrans = imp, data = d, x=TRUE, y=TRUE, surv=TRUE, time.inc=5)
```

```{r fullmodel plots}
# estimation curve for variable
ggplot(Predict(fullmodel), sepdiscrete ='vertical', nlevels=4, vnames ='names')
# estimation result
fullmodel
# figure 1 - importance of each variable
# anova(fullmodel)
plot(anova(fullmodel, tol=1e-13))
```

**Model Validation**
```{r validation, warning = FALSE}
c.stat <- FunDiscrimination(fullmodel, 3)
```

**Model Calibration**
  
```{r calibration, warning = FALSE}
# if we want to predict 10-year risk, change times=5 to times=10.
completed$pred <- 1 - predictSurvProb(fullmodel, completed, times=5)
# event after 5 years is setted to censored status? If so, run following code 
# completed$event[completed$event == 1 & completed$years > 5] <- 0
# table(completed$event)
# if above annotation code is executed, c-statistics for each group is slightly larger.
# predict 10 group's risk probabilities

# predict survival probability and observed probability for overall
dat <-FUN.deciles_mean_pred(completed)
dat.melt <- melt(dat, id.vars = 'Deciles', variable.name = 'Group', value.name = 'Risk')
plot_all_dots(dat.melt)
```

```{r calibration_sex, warning = FALSE, eval = FALSE}
# predict survival probability and observed probability for male group
dat <- FUN.deciles_mean_pred(completed[completed$female == FALSE,])
dat.melt <- melt(dat, id.vars = 'Deciles', variable.name = 'Group', value.name = 'Risk')
p1 <- plot_all_dots(dat.melt)+
            ggtitle("Male")

# predict survival probability and observed probability for female group
dat <- FUN.deciles_mean_pred(completed[completed$female == TRUE,])
dat.melt <- melt(dat, id.vars = 'Deciles', variable.name = 'Group', value.name = 'Risk')
p2 <- plot_all_dots(dat.melt, colours = c('pink', 'darkred'))+
            ggtitle("Female")

multiplot(p1, p2, cols = 1)
```

#### (2) Age interaction 
**Age interaction**
``` {r age interaction, eval = TRUE}
z <- predict(fullmodel, type="terms")
z.age <- z[, "age"]
z.other <- subset(z, select=-age)
f.ia <- cph(fullmodel$y ~ z.age * z.other)
anova(f.ia )
```

```{r, ref.label='validation', warning = FALSE, eval = FALSE}
```

```{r, ref.label='calibration', warning = FALSE, eval = FALSE}
```

#### (3) Simplified model 
**Model approximation** 
  Set at 90% of R^2^

```{r modelapprox, warning = FALSE, message = FALSE}
# figure 2 - r^2 approximation
r <- FUN.approx(fullmodel, completed)
plot(r$r2, r$frac, type="b", ylab="Fraction", xlab=expression(r^2))
tab <- cbind(number=(length(r[[2]])):1, frac=c(r[[1]]), predictor=r[[3]])
tab
# write.csv(tab, "table_r2.csv")

# Validation for the approximate model
c_index <- Cindex_approx(3, formula = fm, data = completed)
```
Mean c-index = `r round(mean(c_index), 4)`

Approx model formula is: 
```{r}
"formula(fm_approx)
approx_model" # Should be derived from 'tab' above, not from bootstrap validation

cutoff <- max(which(tab[,'frac']>0.9))
tab[cutoff:nrow(tab),'predictor']

# save approx model
# model <- fit.mult.impute(fm_approx, fitter = cph, xtrans = imp, data = d, x=TRUE, y=TRUE, surv=TRUE, time.inc=5)
```

```{r, ref.label='calibration', warning = FALSE}
```


